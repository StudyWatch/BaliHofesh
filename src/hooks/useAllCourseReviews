import { useMemo } from "react"; // ייבוא נכון מ־react בלבד
import { useQuery } from "@tanstack/react-query";
import { supabase } from "@/integrations/supabase/client"; // ודא שהנתיב נכון וש־@ מוגדר ב־tsconfig

/** טיפוס לתגובה */
export interface CourseReview {
  id: string;
  course_id: string;
  user_id: string;
  rating: number;
  content?: string;
  review_text?: string;
  tips?: string;
  helpful_count: number;
  is_anonymous: boolean;
  created_at: string;
  user_profile?: {
    name: string;
    avatar_url?: string;
  };
}

/** Hook שמחזיר את כל חוות הדעת */
export function useAllCourseReviews() {
  const query = useQuery<CourseReview[], Error>({
    queryKey: ['all-course-reviews'],
    queryFn: async () => {
      const { data, error } = await supabase
        .from('course_reviews')
        .select('*');
      if (error) throw error;
      return data || [];
    },
    staleTime: 2 * 60 * 1000, // שתי דקות
  });

  // ממיינים מהחדש לישן (אפשר לוותר אם כבר ב-supabase ORDER)
  const sortedReviews = useMemo(() => {
    if (!query.data) return [];
    return [...query.data].sort((a, b) =>
      new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
    );
  }, [query.data]);

  return {
    reviews: sortedReviews,
    isLoading: query.isLoading,
    isError: query.isError,
    error: query.error,
    refetch: query.refetch,
  };
}
